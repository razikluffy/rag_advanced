<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced RAG Q&A</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      background-attachment: fixed;
      color: #e4e4e7;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* SVG Icons */
    .icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      vertical-align: middle;
    }
    
    .icon-sm {
      width: 16px;
      height: 16px;
    }
    
    .icon-lg {
      width: 24px;
      height: 24px;
    }
    
    header {
      padding: 1rem 2rem;
      background: rgba(15, 12, 41, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(139, 92, 246, 0.2);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-shrink: 0;
      position: relative;
      z-index: 200;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    h1 { 
      font-size: 1.35rem; 
      font-weight: 700; 
      background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    /* Documents Dropdown */
    .docs-dropdown {
      position: relative;
      z-index: 250;
    }
    
    .docs-toggle {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      color: #a78bfa;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .docs-toggle:hover {
      background: rgba(139, 92, 246, 0.2);
      transform: translateY(-1px);
    }
    
    .docs-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.5rem;
      background: rgba(30, 27, 75, 0.98);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      min-width: 320px;
      max-width: 400px;
      max-height: 450px;
      overflow: hidden;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
      z-index: 300;
    }
    
    .docs-menu.active {
      display: flex;
      flex-direction: column;
    }
    
    .docs-menu-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid rgba(139, 92, 246, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .docs-menu-header h3 {
      font-size: 0.95rem;
      color: #e4e4e7;
      font-weight: 600;
    }
    
    .btn-upload-small {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      border: none;
      padding: 0.45rem 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    
    .btn-upload-small:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4);
    }
    
    .docs-list {
      padding: 0.75rem;
      overflow-y: auto;
      flex: 1;
    }
    
    .doc-item {
      padding: 0.85rem;
      margin-bottom: 0.5rem;
      background: rgba(139, 92, 246, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      transition: all 0.2s ease;
    }
    
    .doc-item:hover {
      background: rgba(139, 92, 246, 0.12);
      border-color: rgba(139, 92, 246, 0.3);
      transform: translateX(2px);
    }
    
    .doc-item .doc-name {
      font-size: 0.82rem;
      color: #e4e4e7;
      font-weight: 500;
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .doc-item .doc-meta {
      font-size: 0.7rem;
      color: #a1a1aa;
      display: flex;
      justify-content: space-between;
      padding-left: 1.5rem;
    }
    
    .docs-empty {
      padding: 3rem 1.5rem;
      text-align: center;
      color: #71717a;
      font-size: 0.85rem;
      line-height: 1.6;
    }
    
    .layout { 
      flex: 1; 
      display: flex; 
      gap: 0; 
      max-width: 1800px; 
      margin: 0 auto; 
      width: 100%; 
      min-height: 0;
      overflow: hidden;
      height: 100%;
    }
    
    /* Chat History Sidebar */
    .history-sidebar {
      width: 300px;
      flex-shrink: 0;
      background: rgba(15, 12, 41, 0.7);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(139, 92, 246, 0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .history-header {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(139, 92, 246, 0.2);
      flex-shrink: 0;
    }
    
    .history-header h2 { 
      font-size: 1rem; 
      color: #e4e4e7;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-new-chat {
      width: 100%;
      background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%);
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .btn-new-chat:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 12px -1px rgba(236, 72, 153, 0.5);
    }
    
    .btn-new-chat:active { transform: translateY(0); }
    
    #sessionsList {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
    }
    
    .session-item {
      padding: 1rem;
      margin-bottom: 0.6rem;
      background: rgba(139, 92, 246, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .session-item:hover { 
      background: rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.4);
      transform: translateX(4px);
    }
    
    .session-item.active {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.5);
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    
    .session-item .session-title {
      font-size: 0.85rem;
      color: #e4e4e7;
      font-weight: 500;
      margin-bottom: 0.5rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding-right: 2rem;
    }
    
    .session-item .session-meta {
      font-size: 0.7rem;
      color: #a1a1aa;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }
    
    .session-item .btn-delete-session {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
      padding: 0.3rem;
      border-radius: 6px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .session-item:hover .btn-delete-session {
      opacity: 1;
    }
    
    .session-item .btn-delete-session:hover {
      background: rgba(239, 68, 68, 0.4);
      transform: scale(1.1);
    }
    
    .sessions-empty { 
      padding: 3rem 1.5rem; 
      color: #71717a; 
      font-size: 0.85rem; 
      text-align: center;
      line-height: 1.7;
    }
    
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      padding: 1.5rem;
      overflow: hidden;
    }
    
    .chat-section { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      min-height: 0;
      background: rgba(15, 12, 41, 0.5);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(139, 92, 246, 0.2);
      overflow: hidden;
    }
    
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    
    .msg {
      padding: 1.25rem 1.5rem;
      border-radius: 12px;
      max-width: 85%;
      border: 1px solid rgba(139, 92, 246, 0.2);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .msg.user { 
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(124, 58, 237, 0.2) 100%);
      border-color: rgba(139, 92, 246, 0.4);
      align-self: flex-end;
    }
    
    .msg.assistant { 
      background: rgba(30, 27, 75, 0.6);
      backdrop-filter: blur(10px);
      align-self: flex-start;
    }
    
    .msg .meta { 
      font-size: 0.7rem; 
      opacity: 0.8; 
      margin-bottom: 0.6rem; 
      color: #a78bfa;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    
    .msg .content { 
      white-space: pre-wrap; 
      word-break: break-word; 
      line-height: 1.7;
      color: #e4e4e7;
      font-size: 0.95rem;
    }
    
    .citations {
      margin-top: 0.85rem;
      font-size: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .citations span {
      background: rgba(236, 72, 153, 0.15);
      color: #f9a8d4;
      padding: 0.35rem 0.7rem;
      border-radius: 6px;
      border: 1px solid rgba(236, 72, 153, 0.3);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    
    .input-row {
      display: flex;
      gap: 0.75rem;
      padding: 1.25rem;
      border-top: 1px solid rgba(139, 92, 246, 0.2);
      background: rgba(15, 12, 41, 0.4);
      flex-shrink: 0;
    }
    
    #query {
      flex: 1;
      padding: 0.95rem 1.25rem;
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      background: rgba(30, 27, 75, 0.6);
      color: #e4e4e7;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    
    #query:focus { 
      outline: none; 
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
      background: rgba(30, 27, 75, 0.8);
    }
    
    #query::placeholder {
      color: #71717a;
    }
    
    button.primary {
      background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%);
      color: white;
      border: none;
      padding: 0.95rem 2rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.4);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    button.primary:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 12px -1px rgba(236, 72, 153, 0.5);
    }
    
    button.primary:active { transform: translateY(0); }
    
    button.primary:disabled { 
      opacity: 0.5; 
      cursor: not-allowed;
      transform: none;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(15, 12, 41, 0.5);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.4);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.6);
    }
    
    /* Upload modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      padding: 2rem;
      border-radius: 16px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: #e4e4e7;
    }
    
    .file-input-wrapper {
      margin-bottom: 1.5rem;
    }
    
    input[type="file"] {
      display: block;
      width: 100%;
      padding: 0.75rem;
      border: 2px dashed rgba(139, 92, 246, 0.4);
      border-radius: 8px;
      background: rgba(30, 27, 75, 0.4);
      color: #a1a1aa;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    input[type="file"]:hover {
      border-color: rgba(139, 92, 246, 0.6);
      background: rgba(30, 27, 75, 0.6);
    }
    
    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    
    .btn-secondary {
      background: rgba(139, 92, 246, 0.1);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.3);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: rgba(139, 92, 246, 0.2);
    }
    
    .status { 
      font-size: 0.8rem; 
      color: #a1a1aa;
      margin-top: 0.75rem;
      padding: 0.5rem;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 6px;
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    @media (max-width: 768px) { 
      .history-sidebar { width: 0; display: none; }
      .main { padding: 1rem; }
      h1 { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <svg class="icon-lg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="url(#grad1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="url(#grad1)" fill-opacity="0.2"/>
        <path d="M2 17L12 22L22 17" stroke="url(#grad1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 12L12 17L22 12" stroke="url(#grad1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <defs>
          <linearGradient id="grad1" x1="2" y1="2" x2="22" y2="22">
            <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
          </linearGradient>
        </defs>
      </svg>
      <h1>Advanced RAG Q&A</h1>
    </div>
    <div class="header-right">
      <div class="docs-dropdown">
        <button class="docs-toggle" id="docsToggle">
          <svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 12H15M9 16H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L18.7071 8.70711C18.8946 8.89464 19 9.149 19 9.41421V19C19 20.1046 18.1046 21 17 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Documents (<span id="docsCount">0</span>)
          <svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="docs-menu" id="docsMenu">
          <div class="docs-menu-header">
            <h3>Knowledge Base</h3>
            <button class="btn-upload-small" id="openUploadBtn">
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Upload
            </button>
          </div>
          <div class="docs-list" id="docsList">
            <div class="docs-empty">No documents uploaded</div>
          </div>
        </div>
      </div>
    </div>
  </header>
  
  <div class="layout">
    <aside class="history-sidebar">
      <div class="history-header">
        <h2>
          <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 12H8.01M12 12H12.01M16 12H16.01M21 12C21 16.9706 16.9706 21 12 21C10.4607 21 9.01172 20.5819 7.76923 19.8462L3 21L4.15385 16.2308C3.41819 14.9883 3 13.5393 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Chat History
        </h2>
        <button class="btn-new-chat" id="newChatBtn">
          <svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          New Chat
        </button>
      </div>
      <div id="sessionsList">
        <div class="sessions-empty">No conversations yet.<br>Start chatting to create history!</div>
      </div>
    </aside>
    
    <main class="main">
      <div class="chat-section">
        <div id="messages"></div>
        <div class="input-row">
          <input type="text" id="query" placeholder="Ask me anything about your documents..." autocomplete="off">
          <button class="primary" id="askBtn">
            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 8L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Ask
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- Upload Modal -->
  <div class="modal" id="uploadModal">
    <div class="modal-content">
      <div class="modal-header">Upload Documents</div>
      <div class="file-input-wrapper">
        <input type="file" id="files" multiple accept=".pdf,.txt,.md">
      </div>
      <div class="status" id="uploadStatus" style="display: none;"></div>
      <div class="modal-actions">
        <button class="btn-secondary" id="cancelUploadBtn">Cancel</button>
        <button class="primary" id="uploadBtn">Upload</button>
      </div>
    </div>
  </div>

  <script>
    const API = window.location.origin;
    const STORAGE_KEY = 'rag_session_id';
    let sessionId = localStorage.getItem(STORAGE_KEY);
    let allSessions = [];

    // SVG Icons as functions
    function getIcon(name) {
      const icons = {
        user: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        assistant: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.813 15.904L9 18.75L8.187 15.904C7.72555 14.2878 6.71216 12.8762 5.31012 11.9078C3.90808 10.9395 2.20942 10.4758 0.5 10.5918V9.40816C2.20942 9.52415 3.90808 9.06053 5.31012 8.09216C6.71216 7.1238 7.72555 5.71219 8.187 4.09598L9 1.25L9.813 4.09598C10.2744 5.71219 11.2878 7.1238 12.6899 8.09216C14.0919 9.06053 15.7906 9.52415 17.5 9.40816V10.5918C15.7906 10.4758 14.0919 10.9395 12.6899 11.9078C11.2878 12.8762 10.2744 14.2878 9.813 15.904Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 15.5V18.5M18.5 17H21.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        document: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12H15M9 16H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L18.7071 8.70711C18.8946 8.89464 19 9.149 19 9.41421V19C19 20.1046 18.1046 21 17 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        trash: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        message: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 12H8.01M12 12H12.01M16 12H16.01M21 12C21 16.9706 16.9706 21 12 21C10.4607 21 9.01172 20.5819 7.76923 19.8462L3 21L4.15385 16.2308C3.41819 14.9883 3 13.5393 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        clock: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
      };
      return icons[name] || '';
    }

    // Load sessions list
    async function loadSessions() {
      try {
        const r = await fetch(API + '/sessions');
        const data = await r.json();
        allSessions = data.sessions || [];
        renderSessions();
      } catch (e) {
        console.warn('Failed to load sessions:', e);
      }
    }

    // Render sessions list
    function renderSessions() {
      const list = document.getElementById('sessionsList');
      if (!allSessions.length) {
        list.innerHTML = '<div class="sessions-empty">No conversations yet.<br>Start chatting to create history!</div>';
        return;
      }
      
      list.innerHTML = '';
      allSessions.forEach(session => {
        const div = document.createElement('div');
        div.className = 'session-item' + (session.id === sessionId ? ' active' : '');
        div.innerHTML = `
          <div class="session-title">${escapeHtml(session.first_message)}</div>
          <div class="session-meta">
            <span>${getIcon('message')} ${session.message_count} messages</span>
            <span>${getIcon('clock')} ${formatTime(session.last_updated)}</span>
          </div>
          <button class="btn-delete-session" onclick="deleteSession('${session.id}', event)">${getIcon('trash')}</button>
        `;
        div.onclick = (e) => {
          if (!e.target.closest('.btn-delete-session')) {
            switchSession(session.id);
          }
        };
        list.appendChild(div);
      });
    }

    // Switch to a different session
    async function switchSession(newSessionId) {
      sessionId = newSessionId;
      localStorage.setItem(STORAGE_KEY, sessionId);
      await loadConversationHistory();
      renderSessions();
    }

    // Delete a session
    async function deleteSession(sid, event) {
      event.stopPropagation();
      if (!confirm('Delete this conversation?')) return;
      
      try {
        await fetch(API + '/session/' + sid, { method: 'DELETE' });
        if (sid === sessionId) {
          sessionId = null;
          localStorage.removeItem(STORAGE_KEY);
          document.getElementById('messages').innerHTML = '';
        }
        await loadSessions();
      } catch (e) {
        alert('Failed to delete session: ' + e.message);
      }
    }

    // Start new chat
    function newChat() {
      sessionId = null;
      localStorage.removeItem(STORAGE_KEY);
      document.getElementById('messages').innerHTML = '';
      renderSessions();
    }

    // Load conversation history for current session
    async function loadConversationHistory() {
      if (!sessionId) {
        document.getElementById('messages').innerHTML = '';
        return;
      }
      
      try {
        const r = await fetch(API + '/history?session_id=' + sessionId);
        const data = await r.json();
        const history = data.history || [];
        
        document.getElementById('messages').innerHTML = '';
        history.forEach(msg => {
          addMsg(msg.role, msg.content, msg.role === 'assistant' ? [] : undefined, false);
        });
        
        // Scroll to bottom
        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (e) {
        console.warn('Failed to load history:', e);
      }
    }

    async function loadUploadedFiles() {
      try {
        const r = await fetch(API + '/uploaded_files');
        const data = await r.json();
        const files = data.files || [];
        
        document.getElementById('docsCount').textContent = files.length;
        
        const list = document.getElementById('docsList');
        if (!files.length) {
          list.innerHTML = '<div class="docs-empty">No documents uploaded</div>';
          return;
        }
        
        list.innerHTML = '';
        files.forEach(file => {
          const div = document.createElement('div');
          div.className = 'doc-item';
          const uploadDate = new Date(file.upload_time).toLocaleDateString();
          div.innerHTML = `
            <div class="doc-name">${getIcon('document')} ${escapeHtml(file.filename)}</div>
            <div class="doc-meta">
              <span>${file.chunks} chunks</span>
              <span>${uploadDate}</span>
            </div>
            <button class="btn-delete-doc" onclick="deleteDocument('${escapeHtml(file.filename)}')" title="Delete document">
              ${getIcon('trash')}
            </button>
          `;
          list.appendChild(div);
        });
      } catch (e) {
        console.warn('Failed to load uploaded files:', e);
      }
    }

    // Delete a document
    async function deleteDocument(filename) {
      if (!confirm(`Are you sure you want to delete "${filename}"?\nThis will remove all associated knowledge from the system.`)) {
        return;
      }
      
      try {
        const r = await fetch(API + `/document/${encodeURIComponent(filename)}`, {
          method: 'DELETE'
        });
        
        if (!r.ok) {
          const err = await r.json();
          throw new Error(err.detail || 'Failed to delete document');
        }
        
        const data = await r.json();
        console.log('Deleted document:', data);
        
        // Refresh list
        loadUploadedFiles();
        
      } catch (e) {
        alert('Error deleting document: ' + e.message);
        console.error(e);
      }
    }

    // Toggle documents dropdown
    document.getElementById('docsToggle').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('docsMenu').classList.toggle('active');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('docsMenu');
      const toggle = document.getElementById('docsToggle');
      if (!dropdown.contains(e.target) && !toggle.contains(e.target)) {
        dropdown.classList.remove('active');
      }
    });

    function addMsg(role, content, citations, scroll = true) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      let html = '<div class="meta">' + getIcon(role) + ' ' + (role === 'user' ? 'You' : 'Assistant') + '</div>';
      html += '<div class="content">' + escapeHtml(content) + '</div>';
      if (citations && citations.length) {
        html += '<div class="citations">' + citations.map(c => '<span>' + getIcon('document') + ' ' + escapeHtml(c.source) + ', Page ' + escapeHtml(String(c.page)) + '</span>').join('') + '</div>';
      }
      div.innerHTML = html;
      document.getElementById('messages').appendChild(div);
      if (scroll) div.scrollIntoView({ behavior: 'smooth' });
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function formatTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const now = new Date();
      const diff = now - date;
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (hours < 1) return 'Just now';
      if (hours < 24) return hours + 'h ago';
      if (days < 7) return days + 'd ago';
      return date.toLocaleDateString();
    }

    async function ask() {
      const input = document.getElementById('query');
      const q = input.value.trim();
      if (!q) return;
      addMsg('user', q);
      input.value = '';
      document.getElementById('askBtn').disabled = true;
      try {
        const r = await fetch(API + '/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: q, session_id: sessionId })
        });
        const data = await r.json();
        sessionId = data.session_id;
        localStorage.setItem(STORAGE_KEY, sessionId);
        addMsg('assistant', data.answer, data.citations || []);
        await loadSessions(); // Refresh session list
      } catch (e) {
        addMsg('assistant', 'Error: ' + e.message, []);
      }
      document.getElementById('askBtn').disabled = false;
    }

    async function upload() {
      const input = document.getElementById('files');
      const status = document.getElementById('uploadStatus');
      const btn = document.getElementById('uploadBtn');
      if (!input.files.length) { 
        status.style.display = 'block';
        status.textContent = 'Please select files first.'; 
        return; 
      }
      btn.disabled = true;
      status.style.display = 'block';
      status.textContent = 'Uploading...';
      const fd = new FormData();
      for (const f of input.files) fd.append('files', f);
      try {
        const r = await fetch(API + '/upload', { method: 'POST', body: fd });
        const data = await r.json();
        status.textContent = data.results?.map(x => `${x.filename}: ${x.status}`).join(', ') || 'Upload complete!';
        setTimeout(() => {
          closeUploadModal();
          loadUploadedFiles();
        }, 1500);
      } catch (e) {
        status.textContent = 'Error: ' + e.message;
      }
      btn.disabled = false;
    }

    function openUploadModal() {
      document.getElementById('uploadModal').classList.add('active');
      document.getElementById('uploadStatus').style.display = 'none';
      document.getElementById('uploadStatus').textContent = '';
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').classList.remove('active');
      document.getElementById('files').value = '';
    }

    document.getElementById('openUploadBtn').addEventListener('click', openUploadModal);
    document.getElementById('uploadBtn').addEventListener('click', upload);
    document.getElementById('cancelUploadBtn').addEventListener('click', closeUploadModal);
    document.getElementById('askBtn').addEventListener('click', ask);
    document.getElementById('query').addEventListener('keydown', e => { if (e.key === 'Enter') ask(); });
    document.getElementById('newChatBtn').addEventListener('click', newChat);

    // Initialize
    loadSessions();
    loadConversationHistory();
    loadUploadedFiles();
  </script>
</body>
</html>
